HYH-Blog-Gin 优化建议（优先级排序）

概览
- 技术栈：Gin + GORM(PostgreSQL) + Redis + gRPC（图片转换）+ Swagger + Prometheus
- 架构：handlers/services/repository 分层，Redis 缓存与后台计数器回写，图片本地存储（按日期+内容哈希），CI/Docs 基础已具备
- 主要目录：cmd/server（启动/生命周期）、internal（config、database、auth、router、middleware、handlers、services、repository、utils）、migrations、proto、api

P0（正确性/安全，建议尽快落实）
1) CORS 组合不安全/不生效
- 现状：Access-Control-Allow-Origin: * 与 Access-Control-Allow-Credentials: true 同时存在（internal/middleware/cors.go）
- 风险：浏览器将忽略该组合；且生产环境应限制来源域名
- 建议：
  - 若需要携带凭证（cookies/授权头），将 Allow-Origin 改为回显请求源（Origin）或配置白名单，或关闭 Allow-Credentials
  - 基于环境变量配置允许的域名列表

2) Go 版本不一致
- 现状：go.mod 指定 go 1.25；Dockerfile 使用 golang:1.23-alpine 构建
- 风险：编译特性/标准库差异导致不可预期问题
- 建议：统一为 1.25（或将 go.mod 降到 1.23），并在 CI 中固定 Go 版本

3) 配置与实现不一致（上传目录/URL）
- 现状：config.Server.UploadDir/UploadURLPrefix 默认 ./uploads、/uploads；但路由与服务硬编码为 ./static/images 与 /static/images（cmd/server/app.go、router）
- 风险：环境切换/容器化时产生路径混乱、难以维护
- 建议：统一以 Server 配置为准，移除硬编码；路由静态目录与 LocalStorage 使用相同配置

4) AutoMigrate 与 SQL 迁移并存
- 现状：database.NewDB 中执行 AutoMigrate；同时存在 migrations/*.sql
- 风险：生产中易发生不可控结构漂移；迁移来源双轨
- 建议：
  - 本地开发保留 AutoMigrate（可通过 ENV 开关），生产禁用，仅使用 migrations
  - 在 README 明确迁移流程；CI/CD 加入迁移步骤

5) Redis 默认密码与 JWT 默认密钥
- 现状：REDIS_PASSWORD 默认 "123456"；JWT_SECRET 默认 "change-me-in-prod"
- 风险：误用默认弱密码/密钥
- 建议：默认置空或强提示必须显式提供；在启动时检测并告警/拒绝

6) 点赞接口未校验笔记是否存在
- 现状：POST /api/v1/notes/:id/like 直接写 Redis 计数
- 影响：对不存在的 ID 产生脏数据；虽回写 DB 时不会更新任何行，但会浪费资源
- 建议：先从服务/缓存校验 note 是否存在（或轻量 HEAD/exists 查询），不存在返回 404

7) 图片上传强依赖 gRPC 转换
- 现状：client 为空即报错（image_service.Save），Upload 返回 502/500
- 风险：图片服务短暂不可用时，整体功能瘫痪
- 备选：
  - 提供降级：允许直接保存原图（保留 content-type 白名单与体积限制）
  - 或明确在 README/健康检查中暴露“图片服务依赖”与告警

P1（可观测性/稳定性）
1) 日志标准化
- 现状：混用 log.Printf 与 zap；未注入请求范围字段
- 建议：
  - 统一使用 zap，在 Gin 中间件中加入请求 ID、方法、路径、状态码、耗时；错误路径记录栈
  - Request ID 中间件（优先读取 X-Request-Id，不存在则生成）

2) 健康检查增强
- 现状：/healthz、/readyz 未做 DB/Redis 探活
- 建议：
  - /readyz 并发 Ping(DB、Redis、gRPC) 返回聚合状态；Prometheus 友好指标

3) 速率限制/滥用防护
- 建议：对登录、图片上传、点赞等接口添加速率限制（令牌桶/漏桶，基于 Redis 实现）

4) 指标补充
- 建议：对关键接口暴露直方图/计数器（如 image upload 成功/失败、note CRUD、cache 命中率、gRPC 调用耗时）

P1（性能/可扩展）
1) 计数器同步鲁棒性
- 现状：缓存标记脏数据的 SAdd 在 goroutine 中使用调用处传入的 ctx；调用处可能传入短生命周期 ctx
- 建议：使用 context.Background() 或内部新建 context.WithTimeout，避免被上游取消

2) 查询与索引
- 现状：migrations 已建 notes(author_id)、notes(is_public)、images(url)；tags(name) 唯一
- 建议：
  - notes(author_id, created_at) 复合索引，优化作者时间线
  - note_tags(note_id)、note_tags(tag_id) 单列索引（部分数据库会自动利用 PK，但可按需补充）

3) 缓存策略
- 现状：仅 Note FindByID 使用 Redis JSON 缓存；列表/搜索无缓存
- 建议：
  - 可对热门作者的分页结果做短 TTL 缓存（带 page、limit 维度）
  - 明确失效策略（创建/更新/删除时的 key 级联清理）

P2（构建/部署/数据持久化）
1) Compose 静态资源持久化
- 现状：app 容器未挂载静态图片目录为卷
- 建议：为上传目录（与配置一致）绑定卷（如 ./data/uploads:/srv/uploads），避免容器销毁导致数据丢失

2) Docker 镜像与运行时
- 建议：
  - 统一 Go 版本；添加 TZ、LANG 以稳定日志时间
  - 增加健康检查（HEALTHCHECK）或在 compose 中使用 curl /readyz

3) 连接池参数可配置
- 现状：DB 池参数硬编码（SetMaxOpenConns=25 等）
- 建议：通过环境变量暴露，便于不同环境调优

P2（代码质量/一致性）
1) 去重工具函数
- 现状：handlers/note_handler.go 内有 parseUintParam，与 internal/utils/parse.go 功能重复
- 建议：统一使用 utils.ParseUintParam

2) 字段命名一致性
- 现状：Swagger 模型使用 createdAt/updatedAt（小驼峰），GORM/JSON 大多为下划线/小写
- 建议：统一风格（API 上保持一个规范），并在 README 标注

3) README 与实际依赖
- 现状：README 声称存在 .github/workflows/ci.yml（仓库中确有 .github/ 目录，但请确认工作流是否齐全）
- 建议：若缺失则补充；CI 执行 go vet、golangci-lint、go test、构建

4) go.mod 清理
- 观测：存在较多间接依赖与看起来“未来日期”的 genproto 版本（可能由某依赖引入）
- 建议：go mod tidy；如需，明确版本上界，避免拉取不稳定版本

P3（产品/功能性增强）
1) 图片服务降级/异步化
- 异步化转换（上传先存原图 -> 任务队列 -> 转换完成后更新 URL），结合重试/告警

2) 点赞幂等/防刷
- 基于用户维度做去重（如一人一天一次），或采用 BloomFilter/集合

3) 搜索增强
- 现状：按 title/content ILIKE 与 tags 过滤
- 建议：增加摘要字段维护（已有 Summary 字段），在写入时生成；或引入全文检索（PG Trigram/TSVECTORS）

4) 文档与开发者体验
- 在 Swagger 补充更多示例与错误码；生成脚本（make/shell）统一执行 swag init、lint、test

落地建议（最小变更批次）
- 批次A（安全/正确性）：修正 CORS、统一 Go 版本、统一上传目录配置、禁用生产 AutoMigrate、调整默认密钥/密码策略、点赞校验存在性
- 批次B（可观测）：接入 zap 请求日志、Request ID、/readyz 探活整合 DB/Redis/gRPC
- 批次C（存储/部署）：Compose 增加上传目录卷、Docker 健康检查与时区、DB 连接池改为可配置
- 批次D（质量）：去重工具函数、统一字段命名、CI 工作流与 go mod tidy

参考定位（代码位置）
- CORS：internal/middleware/cors.go
- 静态目录/图片服务初始化：cmd/server/app.go、internal/services/storage_local.go、router/router.go
- 计数器同步：cmd/server/counter_sync.go、internal/cache/cache.go
- AutoMigrate：internal/database/postgresql.go
- gRPC 客户端/图片服务：internal/grpcclient/client.go、internal/services/image_service.go
- 配置：internal/config/*.go（server.go、redis.go、jwt.go 等）
- Repositories/业务：internal/repository/*、internal/services/*

如需，我可以按上述批次提交具体改动 PR（含小型单元测试与 CI 更新）。
